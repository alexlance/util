#!/bin/bash
set -euo pipefail

function search_secret() {
  ssh -q -t mail grep -HE "${1}" Passwords/file*.asc
}

function get_remote_secret() {
  echo "${1}" | ssh -q -t mail gpg -d --batch -q --no-tty --passphrase-fd 0 -o - ${2}
}

function store_remote_secret() {
  ssh -q -t mail <<EOF
#!/bin/bash
set -euo pipefail
cd Passwords
num=\$(ls -1 file*[0-9]* | sort | tail -1 | grep -oE '[0-9]+')
let num++
file="file\$(printf "%03d" \${num}).asc"
if [ ! -f "\${file}" ]; then
  echo "writing: \${file}"
  echo -e "${2}" | gpg --batch -q --no-tty -c --passphrase '${1}' \
    --cipher-algo AES256 \
    --digest-algo sha256 \
    --cert-digest-algo sha256 \
    --compress-algo none -z 0 \
    --s2k-mode 3 \
    --s2k-digest-algo sha256 \
    --s2k-count 65011712 \
    --force-mdc \
    -a --comment '${3}' -o \${file}
fi
EOF
}

function validate() {
  test "$(echo "${1}" | md5sum | grep -o '.....$')" == "5c  -" || (echo "Bad gpg passphrase" && exit 1)
}

# retrieve an existing password
if [ ${#} -eq 0 ]; then
  while read -e -p "search for: " query; do
    if [ $(( "$(date +%s)" - ${last_success:-0} )) -gt 43200 ]; then
      read -e -p "passphrase: " -s passphrase
      validate "${passphrase}" && last_success=$(date +%s)
      echo
    fi
    files=$(search_secret "${query}")
    if [ "${files}" ]; then
      file=$(echo "${files}" | sort | tee /dev/stderr | cut -f1 -d':' | tail -1)
      cred="$(get_remote_secret "${passphrase}" "${file}")"
      echo -e "${cred}" | sed "1q;d" | xclip -loops 3 -i -selection primary -f   # username
      echo -e "${cred}" | sed "2q;d" | xclip -loops 3 -i -selection clipboard    # password
      echo -e "${cred}" | sed "3q;d"                                             # additional secret
    fi
  done

# add a new password
elif [ "${1}" == "-a" ]; then
  demo=""
  which apg 2>&1 >/dev/null && demo=" (eg: $(apg -n1 -m 32 -x 64))"
  [ -v passphrase ] || read -e -p "passphrase: " -s passphrase
  validate "${passphrase}"
  [ -v username ]   || read -e -p "username: " username
  [ -v password ]   || read -e -p "password${demo}: " password
  [ -v private ]    || read -e -p "additional secret: " private
  [ -v keywords ]   || read -e -p "searchable keywords: " keywords
  store_remote_secret "${passphrase}" "${username}\n${password}\n${private}\n" "${keywords}"
fi
